<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Classroom Dashboard</title>
    
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='/style.css') }}">
</head>
<body>

    <div class="header-section">
        <div class="d-flex align-items-center">
            <div class="mr-3">
                <a href="/profile" style="text-decoration: none;">
                    <div style="width: 55px; height: 55px; background: #e8eaf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s;">
                        <i class="fas fa-user-cog text-primary fa-lg"></i>
                    </div>
                </a>
            </div>
            <div>
                <h1 class="app-title" style="line-height: 1.2;">Smart Dashboard</h1>
                <div class="text-muted" style="font-size: 0.9rem;">
                    Hello, <a href="/profile" style="color: #4e73df; font-weight: bold; text-decoration: none;">{{ username }}</a>
                </div>
            </div>
        </div>
        
        <div class="d-flex align-items-center">
            <div class="live-badge"><i class="fas fa-circle" style="font-size: 8px; margin-right: 4px;"></i> Live</div>
            <a href="/logout" class="btn btn-outline-danger btn-sm font-weight-bold px-3" style="border-radius: 20px; border-width: 2px;">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </a>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <div class="card">
            <div class="card-header" style="color: #4e73df;">
                <span>Posture AI</span>
                <i class="fas fa-user-check icon-header"></i>
            </div>
            <div class="card-body">
                <div id="postureIcon" style="font-size: 4rem; margin-bottom: 15px; color: #1cc88a; transition: all 0.3s;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="big-data" id="postureValue">Detecting...</div>
                <p class="text-muted mt-2 mb-0">Neck Dist: <span id="neckDistValue" class="font-weight-bold text-dark">0</span> px</p>
                <div class="mt-3 px-3 py-1 bg-light rounded-pill">
                    <small class="text-muted">Session Warnings: <span id="sessionWarnings" class="text-danger font-weight-bold">0</span></small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="color: #36b9cc;">
                <span>Environment</span>
                <i class="fas fa-leaf icon-header"></i>
            </div>
            <div class="card-body">
                <div class="row w-100 align-items-center">
                    <div class="col-6 border-right">
                        <i class="fas fa-thermometer-half text-danger fa-2x mb-2"></i>
                        <div class="big-data" id="temperature">0°C</div>
                        <small class="text-muted font-weight-bold">TEMP</small>
                    </div>
                    <div class="col-6">
                        <i class="fas fa-tint text-primary fa-2x mb-2"></i>
                        <div class="big-data" id="humidity">0%</div>
                        <small class="text-muted font-weight-bold">HUMIDITY</small>
                    </div>
                </div>
                <hr class="w-75 my-3">
                <small class="text-muted"><i class="far fa-clock mr-1"></i> Update: <span id="sensorTimestamp">--:--</span></small>
            </div>
        </div>

        <div class="card" id="gasCard">
            <div class="card-header" style="color: #e74a3b;">
                <span>Safety System</span>
                <i class="fas fa-shield-alt icon-header"></i>
            </div>
            <div class="card-body">
                <div class="big-data" id="gasValue">0</div>
                <div class="text-muted mb-4 font-weight-bold" style="font-size: 0.9rem;">MQ-2 GAS LEVEL</div>
                
                <div id="alarmStatus" class="safe-badge">
                    <i class="fas fa-check-circle"></i> SAFE
                </div>
                <small class="text-muted mt-3">Threshold Limit: 1400</small>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="color: #f6c23e;">
                <span>Smart Light</span>
                <i class="fas fa-lightbulb icon-header"></i>
            </div>
            <div class="card-body">
                <button id="btnLight" class="btn-light-control btn-off" onclick="toggleLight()">
                    <i class="fas fa-power-off"></i>
                </button>
                <div class="mt-4 font-weight-bold" id="lightText" style="font-size: 1.2rem; color: #858796;">OFF</div>
                <small class="text-muted mt-1">Tap icon to toggle</small>
            </div>
        </div>

    </div>

    <div class="card mb-5">
        <div class="card-header text-secondary bg-light">
            <span><i class="fas fa-history mr-2"></i> Recent Work Sessions</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 text-left table-custom">
                    <thead class="thead-light">
                        <tr>
                            <th class="pl-4">Start Time</th>
                            <th>Duration</th>
                            <th class="text-center">Warnings</th>
                            <th>Avg Temp</th>
                            <th>Avg Humid</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in history %}
                        <tr>
                            <td class="pl-4 font-weight-bold text-dark">{{ session.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ session.duration_minutes }} min</td>
                            <td class="text-center">
                                {% if session.warning_count > 5 %}
                                    <span class="badge badge-danger px-3 py-2">{{ session.warning_count }}</span>
                                {% else %}
                                    <span class="badge badge-success px-3 py-2">{{ session.warning_count }}</span>
                                {% endif %}
                            </td>
                            <td>{{ session.avg_temp }}°C</td>
                            <td>{{ session.avg_humidity }}%</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center py-4 text-muted">No working history found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    let isLightOn = false;

    function updateLightUI(status) {
        const btn = document.getElementById('btnLight');
        const txt = document.getElementById('lightText');
        
        if (status === 'ON') {
            isLightOn = true;
            btn.className = "btn-light-control btn-on";
            txt.textContent = "LIGHT ON";
            txt.style.color = "#f6c23e";
        } else {
            isLightOn = false;
            btn.className = "btn-light-control btn-off";
            txt.textContent = "LIGHT OFF";
            txt.style.color = "#858796";
        }
    }

    function toggleLight() {
        const newStatus = isLightOn ? 'OFF' : 'ON'; 
        const btn = document.getElementById('btnLight');
        btn.style.transform = "scale(0.95)";
        
        fetch('/api/v1/light/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            updateLightUI(data.current_status);
            setTimeout(() => {
                if(data.current_status === 'ON') btn.style.transform = "scale(1.05)";
                else btn.style.transform = "scale(1)";
            }, 150);
        })
        .catch(err => console.error(err));
    }

    function fetchData() {
        fetch('/api/v1/data')
            .then(response => response.json())
            .then(data => {
                // A. POSTURE
                const pStatus = data.posture.status;
                document.getElementById('postureValue').textContent = pStatus;
                document.getElementById('neckDistValue').textContent = data.posture.neckDist;
                document.getElementById('sessionWarnings').textContent = data.session_warnings || 0;
                
                const pIcon = document.getElementById('postureIcon');
                if (pStatus === 'GOOD' || pStatus === 'WAITING') {
                    pIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                    pIcon.style.color = '#1cc88a';
                } else {
                    pIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    pIcon.style.color = '#e74a3b';
                }

                // B. ENVIRONMENT
                document.getElementById('temperature').textContent = data.sensors.temperature + '°C';
                document.getElementById('humidity').textContent = data.sensors.humidity + '%';
                document.getElementById('sensorTimestamp').textContent = data.sensors.timestamp;

                // C. GAS & ALARM
                const gasVal = data.sensors.gas || 0;
                const isAlarm = data.sensors.isAlarm || false;
                
                document.getElementById('gasValue').textContent = gasVal;
                
                const alarmDiv = document.getElementById('alarmStatus');
                const gasCard = document.getElementById('gasCard');

                if (gasVal > 1400 || isAlarm) {
                    alarmDiv.className = 'danger-badge';
                    alarmDiv.innerHTML = '<i class="fas fa-radiation-alt"></i> DANGER';
                    gasCard.classList.add('danger-mode');
                } else {
                    alarmDiv.className = 'safe-badge';
                    alarmDiv.innerHTML = '<i class="fas fa-shield-alt"></i> SAFE';
                    gasCard.classList.remove('danger-mode');
                }

                // D. LIGHT
                return fetch('/api/v1/light/status');
            })
            .then(res => res.json())
            .then(lightData => updateLightUI(lightData.status))
            .catch(err => console.error(err));
    }

    setInterval(fetchData, 2000);
    window.onload = fetchData;
</script>

</body>
</html>